name: Build binaries (Win/macOS/Linux) + Release assets

on:
  push:
    branches: [ "master" ]
    tags:     [ "v*" ]
  pull_request:
  workflow_dispatch:

jobs:
  # ---------------------------
  # Linux builds: RHEL7/CentOS7 baseline (glibc 2.17) using manylinux2014
  # ---------------------------
  build_linux:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-rhel7
            runs_on: ubuntu-24.04
            container_image: quay.io/pypa/manylinux2014_x86_64
            glibc_max: "2.17"

          # NOTE: ubuntu-24.04-arm is available on PUBLIC repos; private repos need self-hosted / org arm runners :contentReference[oaicite:3]{index=3}
          - name: linux-arm64-rhel7
            runs_on: ubuntu-24.04-arm
            container_image: quay.io/pypa/manylinux2014_aarch64
            glibc_max: "2.17"

    # manylinux2014 is CentOS 7 based (glibc 2.17) and lists RHEL 7+ compatibility :contentReference[oaicite:4]{index=4}
    container:
      image: ${{ matrix.container_image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version label
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "VERSION=master-${GITHUB_SHA:0:7}" >> "$GITHUB_ENV"
          fi

      - name: Install build tools (CentOS 7)
        shell: bash
        run: |
          set -euxo pipefail
          yum -y install git make which tar gzip
          yum -y install cmake3 || true

      - name: Enable devtoolset (newer GCC for C++17)
        shell: bash
        run: |
          set -euxo pipefail
          if ls /opt/rh/devtoolset-*/enable >/dev/null 2>&1; then
            source "$(ls /opt/rh/devtoolset-*/enable | sort -V | tail -1)"
          fi
          gcc --version
          g++ --version

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          cmake_cmd=cmake
          command -v cmake3 >/dev/null 2>&1 && cmake_cmd=cmake3

          $cmake_cmd -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=stage \
            -DMAKING_STATIC_BUILD=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DUSING_OPENMP=OFF \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++ -static-libgcc"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake_cmd=cmake
          command -v cmake3 >/dev/null 2>&1 && cmake_cmd=cmake3
          $cmake_cmd --build build --config Release --parallel

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir build -C Release --output-on-failure

      - name: Install to staging folder
        shell: bash
        run: |
          set -euxo pipefail
          cmake_cmd=cmake
          command -v cmake3 >/dev/null 2>&1 && cmake_cmd=cmake3
          $cmake_cmd --install build --config Release
          cp -f LICENSE stage/ || true
          cp -f README.md stage/ || true

      - name: Verify max required GLIBC version (must be <= ${{ matrix.glibc_max }})
        shell: bash
        run: |
          set -euxo pipefail
          bin="stage/bin/josim-cli"

          max_ver=$(objdump -T "$bin" 2>/dev/null \
            | sed -n 's/.*GLIBC_\([0-9.]\+\).*/\1/p' \
            | sort -V | tail -1 || true)

          echo "Max GLIBC required: ${max_ver:-<none found>}"

          if [[ -n "$max_ver" ]]; then
            highest=$(printf "${{ matrix.glibc_max }}\n%s\n" "$max_ver" | sort -V | tail -1)
            if [[ "$highest" != "${{ matrix.glibc_max }}" ]]; then
              echo "ERROR: binary requires GLIBC_$max_ver (newer than ${{ matrix.glibc_max }})"
              exit 1
            fi
          fi

      - name: Package (tar.gz)
        shell: bash
        run: |
          set -euxo pipefail
          tar -czf "JoSIM-${VERSION}-${{ matrix.name }}.tar.gz" -C stage .

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-${{ matrix.name }}
          path: JoSIM-${{ env.VERSION }}-${{ matrix.name }}.tar.gz

  # ---------------------------
  # macOS builds: arm64 + x64 (separate runners)
  # ---------------------------
  build_macos:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            name: macos-arm64
          - os: macos-15-intel
            name: macos-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version label
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "VERSION=master-${GITHUB_SHA:0:7}" >> "$GITHUB_ENV"
          fi

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=stage \
            -DMAKING_STATIC_BUILD=OFF

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build build --config Release --parallel

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir build -C Release --output-on-failure

      - name: Install to staging folder
        shell: bash
        run: |
          set -euxo pipefail
          cmake --install build --config Release
          cp -f LICENSE stage/ || true
          cp -f README.md stage/ || true

      - name: Package (tar.gz)
        shell: bash
        run: |
          set -euxo pipefail
          tar -czf "JoSIM-${VERSION}-${{ matrix.name }}.tar.gz" -C stage .

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-${{ matrix.name }}
          path: JoSIM-${{ env.VERSION }}-${{ matrix.name }}.tar.gz

  # ---------------------------
  # Windows build: x64
  # ---------------------------
  build_windows:
    name: Build (windows-x64)
    runs-on: windows-2025

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version label
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -like 'refs/tags/*') { $v = $env:GITHUB_REF_NAME }
          else { $v = "master-$($env:GITHUB_SHA.Substring(0,7))" }
          "VERSION=$v" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX=stage `
            -DMAKING_STATIC_BUILD=ON

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Test
        shell: pwsh
        run: ctest --test-dir build -C Release --output-on-failure

      - name: Install to staging folder
        shell: pwsh
        run: |
          cmake --install build --config Release
          cmake -E copy_if_different LICENSE   stage/ || exit 0
          cmake -E copy_if_different README.md stage/ || exit 0

      - name: Package (zip)
        shell: pwsh
        run: Compress-Archive -Path "stage\*" -DestinationPath "JoSIM-$env:VERSION-windows-x64.zip"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-windows-x64
          path: JoSIM-${{ env.VERSION }}-windows-x64.zip

  # ---------------------------
  # Release: attach all artifacts on tag pushes
  # ---------------------------
  release:
    name: Create GitHub Release (tags only)
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build_linux
      - build_macos
      - build_windows
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Publish release + attach binaries
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
