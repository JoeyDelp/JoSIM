name: Build binaries (Win/macOS/Linux) + Release assets

on:
  push:
    branches: [ "master" ]
    tags:     [ "v*" ]
  pull_request:
  workflow_dispatch:

jobs:
  # ---------------------------
  # Linux builds (RHEL7 baseline) via docker run (NOT job.container)
  # ---------------------------
  build_linux:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-rhel7
            runs_on: ubuntu-24.04
            image: quay.io/pypa/manylinux2014_x86_64
          - name: linux-arm64-rhel7
            runs_on: ubuntu-24.04-arm
            image: quay.io/pypa/manylinux2014_aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache CMake deps (best-effort)
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            .cpm-cache
            ~/.cache
          key: linux-${{ matrix.name }}-${{ hashFiles('**/CMakeLists.txt','**/*.cmake') }}
          restore-keys: |
            linux-${{ matrix.name }}-
            linux-

      - name: Compute version label
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "VERSION=master-${GITHUB_SHA:0:7}" >> "$GITHUB_ENV"
          fi

      - name: Build inside manylinux2014 (RHEL7/glibc 2.17)
        shell: bash
        env:
          CPM_SOURCE_CACHE: ${{ github.workspace }}/.cpm-cache
        run: |
          set -euxo pipefail

          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          IMAGE="${{ matrix.image }}"

          docker pull "$IMAGE"

          docker run --rm \
            -e HOST_UID="$HOST_UID" \
            -e HOST_GID="$HOST_GID" \
            -e CPM_SOURCE_CACHE="/work/.cpm-cache" \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            "$IMAGE" \
            bash -lc '
              set -euxo pipefail

              # Ensure tools exist (manylinux images usually have these; install if missing)
              command -v objdump >/dev/null 2>&1 || yum -y install binutils
              command -v git >/dev/null 2>&1 || yum -y install git
              command -v make >/dev/null 2>&1 || yum -y install make
              command -v cmake >/dev/null 2>&1 || (yum -y install cmake3 || true)

              CMAKE=cmake
              command -v cmake3 >/dev/null 2>&1 && CMAKE=cmake3

              # Clean any previous outputs (optional)
              rm -rf build stage

              $CMAKE -S . -B build \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=stage \
                -DMAKING_STATIC_BUILD=ON \
                -DBUILD_SHARED_LIBS=OFF \
                -DUSING_OPENMP=OFF \
                -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++ -static-libgcc"

              $CMAKE --build build --config Release --parallel
              ctest --test-dir build -C Release --output-on-failure
              $CMAKE --install build --config Release

              cp -f LICENSE stage/ || true
              cp -f README.md stage/ || true

              # Sanity check: ensure we did not accidentally require newer than glibc 2.17 (RHEL7)
              bin="stage/bin/josim-cli"
              max_ver=$(objdump -T "$bin" 2>/dev/null \
                | sed -n "s/.*GLIBC_\\([0-9.]*\\).*/\\1/p" \
                | sort -V | tail -1 || true)
              echo "Max GLIBC required: ${max_ver:-<none found>}"
              if [[ -n "$max_ver" ]]; then
                highest=$(printf "2.17\n%s\n" "$max_ver" | sort -V | tail -1)
                if [[ "$highest" != "2.17" ]]; then
                  echo "ERROR: binary requires GLIBC_$max_ver (newer than 2.17) => not RHEL7 compatible"
                  exit 1
                fi
              fi

              # Fix ownership so the runner can package/clean the workspace
              chown -R "$HOST_UID:$HOST_GID" /work/build /work/stage /work/.cpm-cache || true
            '

      - name: Package (tar.gz)
        shell: bash
        run: |
          set -euxo pipefail
          tar -czf "JoSIM-${VERSION}-${{ matrix.name }}.tar.gz" -C stage .

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-${{ matrix.name }}
          path: JoSIM-${{ env.VERSION }}-${{ matrix.name }}.tar.gz

  # ---------------------------
  # macOS builds: arm64 + x64
  # ---------------------------
  build_macos:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            name: macos-arm64
          - os: macos-15-intel
            name: macos-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version label
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "VERSION=master-${GITHUB_SHA:0:7}" >> "$GITHUB_ENV"
          fi

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=stage \
            -DMAKING_STATIC_BUILD=OFF

      - name: Build
        shell: bash
        run: cmake --build build --config Release --parallel

      - name: Test
        shell: bash
        run: ctest --test-dir build -C Release --output-on-failure

      - name: Install to staging folder
        shell: bash
        run: |
          set -euxo pipefail
          cmake --install build --config Release
          cp -f LICENSE stage/ || true
          cp -f README.md stage/ || true

      - name: Package (tar.gz)
        shell: bash
        run: tar -czf "JoSIM-${VERSION}-${{ matrix.name }}.tar.gz" -C stage .

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-${{ matrix.name }}
          path: JoSIM-${{ env.VERSION }}-${{ matrix.name }}.tar.gz

  # ---------------------------
  # Windows build: x64
  # ---------------------------
  build_windows:
    name: Build (windows-x64)
    runs-on: windows-2025

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version label
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -like 'refs/tags/*') { $v = $env:GITHUB_REF_NAME }
          else { $v = "master-$($env:GITHUB_SHA.Substring(0,7))" }
          "VERSION=$v" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX=stage `
            -DMAKING_STATIC_BUILD=ON

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Test
        shell: pwsh
        run: ctest --test-dir build -C Release --output-on-failure

      - name: Install to staging folder
        shell: pwsh
        run: |
          cmake --install build --config Release
          cmake -E copy_if_different LICENSE   stage/ || exit 0
          cmake -E copy_if_different README.md stage/ || exit 0

      - name: Package (zip)
        shell: pwsh
        run: Compress-Archive -Path "stage\*" -DestinationPath "JoSIM-$env:VERSION-windows-x64.zip"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: JoSIM-${{ env.VERSION }}-windows-x64
          path: JoSIM-${{ env.VERSION }}-windows-x64.zip

  # ---------------------------
  # Release: attach all artifacts on tag pushes
  # ---------------------------
  release:
    name: Create GitHub Release (tags only)
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build_linux
      - build_macos
      - build_windows
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Publish release + attach binaries
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
